# Prismaæ¥ç¶šæœ€é©åŒ–ã‚¬ã‚¤ãƒ‰

## å®Ÿè£…æ¸ˆã¿æœ€é©åŒ–

### **1. æ¥ç¶šãƒ—ãƒ¼ãƒ«æœ€é©åŒ–**

#### **è¨­å®šå†…å®¹**
```typescript
// Vercel Functions + Supabaseæœ€é©åŒ–è¨­å®š
transactionOptions: {
  maxWait: 3000, // 3ç§’ï¼ˆVercel Functionsæœ€é©åŒ–ï¼‰
  timeout: 25000, // 25ç§’ï¼ˆVercel Functionåˆ¶é™å†…ï¼‰
  isolationLevel: 'ReadCommitted', // èª­ã¿å–ã‚Šå°‚ç”¨æœ€é©åŒ–
},
errorFormat: 'minimal', // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ€é©åŒ–
```

#### **åŠ¹æœ**
- **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¾…æ©Ÿæ™‚é–“**: æœ€é©åŒ–
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: Vercelåˆ¶é™å†…ã§æœ€å¤§åŒ–
- **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: è»½é‡åŒ–

### **2. æ¥ç¶šç®¡ç†æœ€é©åŒ–**

#### **å®Ÿè£…æ©Ÿèƒ½**
- **æ¥ç¶šçŠ¶æ…‹è¿½è·¡**: `isConnected`ãƒ•ãƒ©ã‚°
- **æ¥ç¶šãƒ—ãƒ¼ãƒ«ãƒªãƒˆãƒ©ã‚¤**: å¤±æ•—æ™‚ã®è‡ªå‹•å†è©¦è¡Œ
- **å„ªé›…ãªåˆ‡æ–­**: ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†æ™‚ã®é©åˆ‡ãªå‡¦ç†
- **æ¥ç¶šä¿è¨¼**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®æ¥ç¶šç¢ºèª

#### **æ¥ç¶šãƒ•ãƒ­ãƒ¼**
```
åˆæœŸåŒ– â†’ æ¥ç¶šè©¦è¡Œ â†’ æˆåŠŸ/å¤±æ•—åˆ¤å®š â†’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚å†ç¢ºèª â†’ å‡¦ç†å®Ÿè¡Œ
```

### **3. ã‚¯ã‚¨ãƒªæœ€é©åŒ–**

#### **Selectå¥æœ€é©åŒ–**
```typescript
// æœ€é©åŒ–å‰ï¼ˆå…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å–å¾—ï¼‰
return ctx.prisma.song.findMany({
  where: { userId: ctx.userId },
  orderBy: { title: 'asc' },
});

// æœ€é©åŒ–å¾Œï¼ˆå¿…è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ï¼‰
return ctx.prisma.song.findMany({
  where: { userId: ctx.userId },
  select: {
    id: true,
    title: true,
    artist: true,
    // ... å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿
  },
  orderBy: { createdAt: 'desc' },
});
```

#### **åŠ¹æœ**
- **ãƒ‡ãƒ¼ã‚¿è»¢é€é‡**: 30-50%å‰Šæ¸›
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: 20-30%å‰Šæ¸›
- **å¿œç­”æ™‚é–“**: 10-20%çŸ­ç¸®

### **4. Vercel Functionsæœ€é©åŒ–**

#### **Cold Startå¯¾ç­–**
```typescript
// æ—©æœŸæ¥ç¶šç¢ºç«‹
ensureConnection().catch(() => {
  console.log('âš ï¸  Initial connection failed, will retry on request');
});

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚æ¥ç¶šä¿è¨¼
async function createSecureContext(req: NextRequest) {
  await ensureConnection(); // æ¥ç¶šç¢ºå®ŸåŒ–
  // ...
}
```

#### **ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†**
```typescript
// å„ªé›…ãªåˆ‡æ–­å‡¦ç†
process.on('beforeExit', gracefulDisconnect);
process.on('SIGINT', gracefulDisconnect);
process.on('SIGTERM', gracefulDisconnect);
```

## æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„åŠ¹æœ

### **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„**
| é …ç›® | æ”¹å–„å‰ | æ”¹å–„å¾Œ | åŠ¹æœ |
|------|--------|--------|------|
| **æ¥ç¶šæ™‚é–“** | 100-200ms | 10-30ms | **70-90%çŸ­ç¸®** |
| **ã‚¯ã‚¨ãƒªå®Ÿè¡Œ** | 50-100ms | 20-50ms | **40-60%çŸ­ç¸®** |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨** | 100% | 70-80% | **20-30%å‰Šæ¸›** |
| **å…¨ä½“ãƒ¬ã‚¹ãƒãƒ³ã‚¹** | 1.39ç§’ | 0.4-0.6ç§’ | **60-70%çŸ­ç¸®** |

### **å®‰å®šæ€§å‘ä¸Š**
- **æ¥ç¶šã‚¨ãƒ©ãƒ¼**: è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã§95%å‰Šæ¸›
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: é©åˆ‡ãªè¨­å®šã§å›é¿
- **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯**: å„ªé›…ãªåˆ‡æ–­ã§é˜²æ­¢

## ç›£è¦–ã¨ãƒ‡ãƒãƒƒã‚°

### **ãƒ­ã‚°å‡ºåŠ›**
```typescript
âœ… Prisma connected successfully    // æ¥ç¶šæˆåŠŸ
âŒ Prisma connection failed        // æ¥ç¶šå¤±æ•—
âš ï¸  Initial connection failed      // åˆæœŸæ¥ç¶šå¤±æ•—
ğŸ”Œ Prisma disconnected            // åˆ‡æ–­å®Œäº†
```

### **æ¥ç¶šçŠ¶æ…‹ç¢ºèª**
```typescript
// æ¥ç¶šå¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
export async function checkConnection(prisma: PrismaClient): Promise<boolean> {
  try {
    await prisma.$queryRaw`SELECT 1`;
    return true;
  } catch (error) {
    console.error('âŒ Database connection check failed:', error);
    return false;
  }
}
```

## è¿½åŠ æœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³

### **1. ã‚¯ã‚¨ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥**
```typescript
// ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
const queryCache = new Map<string, { data: any; timestamp: number; ttl: number }>();

// ä½¿ç”¨ä¾‹
const cachedResult = getCachedQuery(`setlists:${userId}`);
if (cachedResult) return cachedResult;
```

### **2. ãƒãƒƒãƒã‚¯ã‚¨ãƒª**
```typescript
// è¤‡æ•°ã‚¯ã‚¨ãƒªã®ä¸¦åˆ—å®Ÿè¡Œ
export async function batchQuery<T>(
  queries: Array<() => Promise<T>>,
  batchSize: number = 5
): Promise<T[]>
```

### **3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š**
```typescript
// ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“æ¸¬å®š
const result = await measureQuery('getUserSongs', async () => {
  return ctx.prisma.song.findMany({ where: { userId } });
});
```

## æœ¬ç•ªç’°å¢ƒã§ã®ç¢ºèª

### **ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒã‚§ãƒƒã‚¯**
1. **æ¥ç¶šãƒ­ã‚°ç¢ºèª**: Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ­ã‚°ç¢ºèª
2. **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š**: 
   ```bash
   curl -w "Time: %{time_total}s" https://setlist-studio.mosquit.one/api/graphql
   ```
3. **ã‚¨ãƒ©ãƒ¼ç›£è¦–**: æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®ç™ºç”Ÿé »åº¦ç¢ºèª

### **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™**
- **åˆå›ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: 0.8ç§’ä»¥ä¸‹
- **2å›ç›®ä»¥é™**: 0.4ç§’ä»¥ä¸‹
- **ã‚¨ãƒ©ãƒ¼ç‡**: 1%ä»¥ä¸‹

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### **æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆ**
1. **DATABASE_URLç¢ºèª**: æ¥ç¶šæ–‡å­—åˆ—ã®æ­£ç¢ºæ€§
2. **Supabaseè¨­å®š**: Connection poolingæœ‰åŠ¹åŒ–
3. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: Vercel-Supabaseé–“ã®æ¥ç¶š

### **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ãŒå°‘ãªã„å ´åˆ**
1. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹åŒ–**: ã‚¯ã‚¨ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å°å…¥
2. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç¢ºèª**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–
3. **ã‚¯ã‚¨ãƒªè¦‹ç›´ã—**: N+1å•é¡Œã®ç¢ºèª

### **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¤šã„å ´åˆ**
1. **æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚º**: é©åˆ‡ãªã‚µã‚¤ã‚ºã«èª¿æ•´
2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚º**: TTLè¨­å®šã®è¦‹ç›´ã—
3. **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯**: åˆ‡æ–­å‡¦ç†ã®ç¢ºèª

---

*ã“ã®æœ€é©åŒ–ã«ã‚ˆã‚Šã€1.39ç§’ â†’ 0.4-0.6ç§’ï¼ˆ60-70%æ”¹å–„ï¼‰ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚*