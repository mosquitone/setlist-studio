# Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã‚’å°å…¥ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“‹ å‰ææ¡ä»¶

- Node.js ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- pnpm ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ï¼ˆ`npm install -g pnpm`ï¼‰
- PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç¨¼åƒã—ã¦ã„ã‚‹ã“ã¨
- `.env.local`ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”¨ï¼‰ã¨ `.env.vercel`ï¼ˆæœ¬ç•ªç”¨ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨

## ğŸ¯ ãªãœãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã‹ï¼Ÿ

ç¾åœ¨ã€`prisma db push`ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã«ã¯ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼š

- **å±¥æ­´ãŒæ®‹ã‚‰ãªã„**: ã©ã®ã‚ˆã†ãªå¤‰æ›´ã‚’ã„ã¤è¡Œã£ãŸã‹åˆ†ã‹ã‚‰ãªã„
- **ãƒãƒ¼ãƒ é–‹ç™ºãŒå›°é›£**: ä»–ã®é–‹ç™ºè€…ãŒDBã®å¤‰æ›´ã‚’è¿½è·¡ã§ããªã„
- **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ããªã„**: å•é¡ŒãŒç™ºç”Ÿã—ã¦ã‚‚å‰ã®çŠ¶æ…‹ã«æˆ»ã›ãªã„

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ã†ã“ã¨ã§ã€ã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã§ãã¾ã™ã€‚

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª

**`.env.local`ã®ç¢ºèª**
```bash
# ä»¥ä¸‹ã®2ã¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
DATABASE_URL="postgresql://postgres:postgres_dev_secure@localhost:5432/setlist_generator"
SHADOW_DATABASE_URL="postgresql://postgres:postgres_dev_secure@localhost:5432/setlist_generator_shadow"
```

**`.env.vercel`ã®ä½œæˆ**ï¼ˆã¾ã ãªã„å ´åˆï¼‰
```bash
# .env.localã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½œæˆ
cp .env.local .env.vercel

# .env.vercelã‚’ç·¨é›†ã—ã¦æœ¬ç•ªDBã®URLã«å¤‰æ›´
DATABASE_URL="postgres://your-production-database-url"
# Shadow DBã¯æœ¬ç•ªç’°å¢ƒã§ã¯ä¸è¦
```

### ã‚¹ãƒ†ãƒƒãƒ—2: Shadow Database ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰

Shadow Databaseã¯ã€PrismaãŒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ä¸€æ™‚çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚

```bash
# Shadow DBã‚’ä½œæˆ
pnpm db:setup:shadow

# æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
# âœ… Shadow database 'setlist_generator_shadow' created successfully
```

### ã‚¹ãƒ†ãƒƒãƒ—3: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ã®ç¢ºèª

**ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ç¢ºèª**
```bash
# ç¾åœ¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
pnpm db:migrate:status
```

**æœ¬ç•ªç’°å¢ƒã®ç¢ºèª**ï¼ˆæ…é‡ã«ï¼ï¼‰
```bash
# æœ¬ç•ªDBã®çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆèª­ã¿å–ã‚Šã®ã¿ï¼‰
pnpm db:prod:migrate:status
```

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³åŒ–ã®å®Ÿè¡Œ

#### ğŸ”´ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®å ´åˆ

**æ–¹æ³•A: ã‚¯ãƒªãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆæ¨å¥¨ï¼‰**
```bash
# 1. æ—¢å­˜ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
mv prisma/migrations prisma/migrations_backup

# 2. æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir -p prisma/migrations

# 3. ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰åˆå›ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
pnpm db:migrate:create --name init

# 4. ç”Ÿæˆã•ã‚ŒãŸSQLã‚’ç¢ºèª
cat prisma/migrations/*_init/migration.sql

# 5. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
pnpm prisma migrate resolve --applied "*_init"
```

**æ–¹æ³•B: æ—¢å­˜ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨**
```bash
# æ—¢å­˜ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é †ç•ªã«é©ç”¨æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
pnpm prisma migrate resolve --applied "20250701120235_add_security_tables"
pnpm prisma migrate resolve --applied "20250718000000_add_audit_logs"
pnpm prisma migrate resolve --applied "20250727193129_add_token_unique_constraints"
```

#### ğŸ”µ æœ¬ç•ªç’°å¢ƒã®å ´åˆï¼ˆè¦æ³¨æ„ï¼ï¼‰

æœ¬ç•ªç’°å¢ƒã§ã¯ã€ãƒ‡ãƒ¼ã‚¿æå¤±ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã‚ˆã‚Šæ…é‡ã«ä½œæ¥­ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
# 1. ã¾ãšæœ¬ç•ªDBã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ï¼ˆé‡è¦ï¼ï¼‰
# Supabaseã®å ´åˆ: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
# ãã®ä»–: pg_dumpç­‰ã‚’ä½¿ç”¨

# 2. æœ¬ç•ªç’°å¢ƒã®çŠ¶æ…‹ã‚’ç¢ºèª
pnpm db:prod:migrate:status

# 3. ãƒ­ãƒ¼ã‚«ãƒ«ã¨åŒã˜ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
# æ³¨æ„: æœ¬ç•ªç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯æ…é‡ã«ï¼
NODE_ENV=production pnpm prisma migrate resolve --applied "20250701120235_add_security_tables" --schema ./prisma/schema.prisma
NODE_ENV=production pnpm prisma migrate resolve --applied "20250718000000_add_audit_logs" --schema ./prisma/schema.prisma
NODE_ENV=production pnpm prisma migrate resolve --applied "20250727193129_add_token_unique_constraints" --schema ./prisma/schema.prisma
```

### ã‚¹ãƒ†ãƒƒãƒ—5: å‹•ä½œç¢ºèª

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ç¢ºèª
pnpm db:migrate:status

# å‡ºåŠ›ä¾‹:
# Database schema is up to date!
# 
# Applied migrations:
# - 20250701120235_add_security_tables
# - 20250718000000_add_audit_logs
# - 20250727193129_add_token_unique_constraints
```

## ğŸ“ ä»Šå¾Œã®é–‹ç™ºãƒ•ãƒ­ãƒ¼

### æ–°ã—ã„æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹å ´åˆ

```bash
# 1. schema.prismaã‚’ç·¨é›†
# ä¾‹: model NewFeature { ... } ã‚’è¿½åŠ 

# 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
pnpm db:migrate:create --name add_new_feature

# 3. ç”Ÿæˆã•ã‚ŒãŸSQLã‚’ç¢ºèª
cat prisma/migrations/*_add_new_feature/migration.sql

# 4. å•é¡Œãªã‘ã‚Œã°é©ç”¨
pnpm db:migrate

# 5. ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œ
git pull
pnpm db:migrate:deploy
```

### æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨

```bash
# 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒGitã«ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
git status

# 2. æœ¬ç•ªç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
pnpm db:prod:migrate:deploy

# ã¾ãŸã¯ã€Vercelã®å ´åˆã¯ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰ã«å«ã‚ã‚‹
# package.jsonã®buildã‚¹ã‚¯ãƒªãƒ—ãƒˆ:
# "build": "prisma migrate deploy && next build"
```

## ğŸ†˜ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Shadow DBã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆ

```bash
# ã‚¨ãƒ©ãƒ¼: Shadow database error
# è§£æ±ºæ³•:
pnpm db:setup:shadow
# ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ã€PostgreSQLã«ç›´æ¥æ¥ç¶šã—ã¦ä½œæˆ
psql -U postgres -c "CREATE DATABASE setlist_generator_shadow;"
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã™ã‚‹å ´åˆ

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã‚‹ã®ã§æ³¨æ„ï¼ï¼‰
pnpm db:migrate:reset

# ç‰¹å®šã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã ã‘ã‚„ã‚Šç›´ã™
pnpm prisma migrate resolve --rolled-back "migration_name"
pnpm db:migrate
```

### æœ¬ç•ªç’°å¢ƒã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆ

```bash
# 1. çµ¶å¯¾ã«ãƒ‘ãƒ‹ãƒƒã‚¯ã«ãªã‚‰ãªã„
# 2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜éŒ²
# 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
# 4. å¿…è¦ã«å¿œã˜ã¦å°‚é–€å®¶ã«ç›¸è«‡
```

## ğŸ“š ã‚³ãƒãƒ³ãƒ‰ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒç”¨ã‚³ãƒãƒ³ãƒ‰

| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ |
|---------|------|
| `pnpm db:migrate` | æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆãƒ»é©ç”¨ |
| `pnpm db:migrate:create` | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆé©ç”¨ã—ãªã„ï¼‰ |
| `pnpm db:migrate:deploy` | æ—¢å­˜ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ |
| `pnpm db:migrate:status` | ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª |
| `pnpm db:migrate:reset` | DBã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå±é™ºï¼ï¼‰ |

### æœ¬ç•ªç’°å¢ƒç”¨ã‚³ãƒãƒ³ãƒ‰

| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ |
|---------|------|
| `pnpm db:prod:migrate:deploy` | æœ¬ç•ªç’°å¢ƒã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ |
| `pnpm db:prod:migrate:status` | æœ¬ç•ªç’°å¢ƒã®çŠ¶æ…‹ã‚’ç¢ºèª |
| `pnpm db:prod:push` | ç·Šæ€¥æ™‚ã®ã¿ï¼šschema.prismaã‚’ç›´æ¥é©ç”¨ |
| `pnpm db:prod:studio` | æœ¬ç•ªDBã‚’GUIã§ç¢ºèªï¼ˆèª­ã¿å–ã‚Šæ¨å¥¨ï¼‰ |

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `.env.local`ã«`SHADOW_DATABASE_URL`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] `.env.vercel`ãŒä½œæˆã•ã‚Œã€æœ¬ç•ªDBæƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] Shadow DatabaseãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
- [ ] æ—¢å­˜ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] `pnpm db:migrate:status`ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„
- [ ] ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã«å¤‰æ›´ã‚’å…±æœ‰ã—ãŸ

## ğŸ‰ å®Œäº†ï¼

ã“ã‚Œã§ã€Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
ä»Šå¾Œã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¤‰æ›´å±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œã€ãƒãƒ¼ãƒ é–‹ç™ºãŒã‚ˆã‚Šå®‰å…¨ã«ãªã‚Šã¾ã™ã€‚

è³ªå•ã‚„å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€é æ…®ãªããƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ã«ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚